<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, orientation=landscape">
    <title>Firework Tycoon V8.1</title>
    <link href="https://fonts.googleapis.com/css2?family=Russo+One&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #050508;
            --glass: rgba(30, 30, 50, 0.7);
            --border: 1px solid rgba(255,255,255,0.2);
            --neon-gold: #ffd700;
            --neon-green: #00ff66;
            --btn-size: 55px;
        }
        body {
            margin: 0; overflow: hidden; background: var(--bg);
            font-family: 'Russo One', sans-serif;
            color: white; user-select: none; touch-action: none;
            position: fixed; width: 100%; height: 100%;
        }
        canvas { display: block; width: 100%; height: 100%; position: absolute; z-index: 1; }
        #ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 10;
            display: flex; flex-direction: column; justify-content: space-between;
        }
        .top-bar {
            display: flex; justify-content: space-between; align-items: center;
            padding: 10px 20px; background: linear-gradient(to bottom, rgba(0,0,0,0.8), transparent);
        }
        .stats-box {
            display: flex; flex-direction: column; gap: 5px;
            text-shadow: 0 2px 4px black;
        }
        .money { color: var(--neon-green); font-size: 22px; display: flex; align-items: center; gap: 5px; }
        .combo { color: var(--neon-gold); font-size: 16px; opacity: 0; transition: 0.3s; }
        .combo.active { opacity: 1; transform: scale(1.2); }
        .sequencer-wrapper {
            pointer-events: auto;
            display: flex; align-items: center; gap: 10px;
            background: var(--glass); padding: 8px; border-radius: 15px; border: var(--border);
        }
        .seq-slots { display: flex; gap: 5px; }
        .slot {
            width: 45px; height: 45px; border-radius: 8px;
            background: rgba(0,0,0,0.5); border: 2px dashed rgba(255,255,255,0.3);
            display: flex; align-items: center; justify-content: center;
            position: relative; cursor: pointer;
        }
        .slot.recording { border-color: #ff0055; animation: pulse 1s infinite; }
        .slot.filled { border-style: solid; border-color: white; color: white; text-shadow: 0 0 4px black; }
        .slot-icon { font-size: 20px; z-index: 2; }
        .mini-btn {
            width: 35px; height: 35px; border-radius: 50%; border: none;
            background: rgba(255,255,255,0.1); color: white; cursor: pointer;
            display: flex; align-items: center; justify-content: center; font-size: 16px;
        }
        .mini-btn:active { transform: scale(0.9); }
        .btn-play { background: var(--neon-green); color: black; box-shadow: 0 0 10px var(--neon-green); }
        .btn-trash { background: #ff3b30; }
        .top-right { pointer-events: auto; }
        .btn-clear-canvas {
            background: rgba(255,255,255,0.2); padding: 8px 16px; border-radius: 20px;
            border: 1px solid white; color: white; font-family: inherit; cursor: pointer;
        }
        .bottom-controls {
            display: flex; justify-content: space-between; padding: 15px;
            pointer-events: auto;
        }
        .pad-container {
            background: var(--glass); padding: 10px; border-radius: 20px; border: var(--border);
            display: flex; flex-direction: column; align-items: center; gap: 5px;
        }
        .pad-label { font-size: 10px; opacity: 0.7; letter-spacing: 1px; }
        .pad-grid {
            display: grid; gap: 8px;
        }
        .pad-left { grid-template-columns: repeat(2, var(--btn-size)); }
        .pad-right { grid-template-columns: repeat(2, var(--btn-size)); }
        .btn-pad {
            width: var(--btn-size); height: var(--btn-size);
            border-radius: 12px; border: 2px solid transparent;
            background: rgba(0,0,0,0.3); position: relative;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            cursor: pointer; font-size: 24px;
        }
        .btn-pad.selected { border-color: white; background: rgba(255,255,255,0.2); transform: scale(1.05); }
        .btn-pad.locked { opacity: 0.8; filter: grayscale(0.8); border: 1px solid #444; }
        .btn-pad.random-color.selected { box-shadow: 0 0 15px #f0f; border-color: #f0f; }
        .lock-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); border-radius: 10px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .price-tag { font-size: 10px; color: var(--neon-gold); margin-top: 2px; font-weight: bold; }
        @keyframes pulse { 0% { box-shadow: 0 0 5px #ff0055; } 50% { box-shadow: 0 0 15px #ff0055; } }
        .float-txt {
            position: absolute; pointer-events: none; font-size: 20px; font-weight: bold;
            animation: floatUp 1s forwards; z-index: 20;
        }
        @keyframes floatUp { 0% { transform:translate(-50%,0); opacity:0; } 20% { opacity:1; } 100% { transform:translate(-50%,-50px); opacity:0; } }

        .fire-button-container {
            position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);
            pointer-events: auto; z-index: 100;
        }
        #fire-button {
            background: linear-gradient(45deg, #00f3ff, #00ff66);
            border: 2px solid white; border-radius: 30px;
            color: black; font-family: 'Russo One', sans-serif; font-size: 24px;
            padding: 15px 40px; cursor: pointer;
            box-shadow: 0 0 20px rgba(0,255,255,0.7);
        }
        #fire-button:active { transform: scale(0.95); box-shadow: 0 0 10px rgba(0,255,255,0.7); }
    </style>
</head>
<body>

<canvas id="canvas"></canvas>

<div id="ui-layer">
    <div class="top-bar">
        <div class="stats-box">
            <div class="money">üí∞ <span id="money-display">0</span></div>
            <div class="combo" id="combo-display">2x COMBO!</div>
        </div>

        <div class="sequencer-wrapper">
            <button class="mini-btn btn-trash" onclick="clearSequence()">üóëÔ∏è</button>
            <div class="seq-slots">
                <div class="slot" id="slot-0" onclick="recordToggle(0)">1</div>
                <div class="slot" id="slot-1" onclick="recordToggle(1)">2</div>
                <div class="slot" id="slot-2" onclick="recordToggle(2)">3</div>
                <div class="slot" id="slot-3" onclick="recordToggle(3)">4</div>
            </div>
            <button class="mini-btn btn-play" onclick="playSequence()">‚ñ∂</button>
        </div>

        <div class="top-right">
            <button class="btn-clear-canvas" onclick="clearVisuals()">üßπ Limpar Tela</button>
        </div>
    </div>

    <div class="bottom-controls">
        <div class="pad-container">
            <span class="pad-label">CORES</span>
            <div class="pad-grid pad-left" id="pad-colors"></div>
        </div>
        <div class="pad-container">
            <span class="pad-label">FORMAS (LOJA)</span>
            <div class="pad-grid pad-right" id="pad-shapes"></div>
        </div>
    </div>
</div>

<div class="fire-button-container">
    <button id="fire-button" onclick="launchFirework()">DISPARAR</button>
</div>

<script>
const DATA = {
    money: 100, 
    unlocked: ['circle', 'star'],
    selectedColor: '#ff0055',
    selectedShape: 'circle',
    sequence: [null, null, null, null],
    recSlot: null
};

const COLORS = [
    {c:'#ff0055', i:'üî¥'}, {c:'#00f3ff', i:'üîµ'},
    {c:'#00ff66', i:'üü¢'}, {c:'#ffd700', i:'üü°'},
    {c:'#ff00ff', i:'üü£'}, {c:'#ffffff', i:'‚ö™'},
    {c:'random', i:'üåà'}
];

const SHAPES = [
    {id:'circle', i:'‚óè', price:0},
    {id:'star',   i:'‚òÖ', price:0}, 
    {id:'heart',  i:'‚ô•', price:200},
    {id:'ring',   i:'‚óé', price:500},
    {id:'spiral', i:'üåÄ', price:1000},
    {id:'atom',   i:'‚öõ', price:2500},
    {id:'mega',   i:'‚ò¢', price:5000}
];

const AudioSys = {
    ctx: null, masterGain: null,
    init(){
        if(!this.ctx){
            this.ctx = new (window.AudioContext||window.webkitAudioContext)();
            this.masterGain = this.ctx.createGain();
            this.masterGain.gain.value = 0.8; 
            this.masterGain.connect(this.ctx.destination);
        }
        if(this.ctx.state==='suspended') this.ctx.resume();
    },
    playEffect(type){
        if(!this.ctx) return;
        const t = this.ctx.currentTime;
        const osc = this.ctx.createOscillator();
        const gain = this.ctx.createGain();
        osc.connect(gain); gain.connect(this.masterGain);

        if(type === 'buy'){
            osc.type = 'sine';
            osc.frequency.setValueAtTime(1200, t);
            osc.frequency.setValueAtTime(2000, t+0.1);
            gain.gain.setValueAtTime(0.1, t);
            gain.gain.linearRampToValueAtTime(0, t+0.2);
            osc.start(t); osc.stop(t+0.2);
        } else if(type === 'error'){
            osc.type = 'sawtooth';
            osc.frequency.value = 150;
            gain.gain.setValueAtTime(0.1, t);
            gain.gain.linearRampToValueAtTime(0, t+0.2);
            osc.start(t); osc.stop(t+0.2);
        }
    },
    playLaunch(){
        if(!this.ctx) return;
        const t = this.ctx.currentTime;
        const osc = this.ctx.createOscillator();
        const gain = this.ctx.createGain();
        osc.type = 'sine';
        osc.frequency.setValueAtTime(200, t);
        osc.frequency.exponentialRampToValueAtTime(1000, t + 0.5);
        gain.gain.setValueAtTime(0.05, t);
        gain.gain.linearRampToValueAtTime(0, t + 0.5);
        osc.connect(gain); gain.connect(this.masterGain);
        osc.start(t); osc.stop(t + 0.5);
    },
    playBoom(size = 1) {
        if(!this.ctx) return;
        const t = this.ctx.currentTime;
        
        const type = Math.floor(Math.random() * 3) + 1; 
        const baseDuration = 0.3 + size * 0.1;

        const sub = this.ctx.createOscillator();
        const gSub = this.ctx.createGain();
        sub.type = 'sine';
        sub.frequency.setValueAtTime(40, t); 
        sub.frequency.exponentialRampToValueAtTime(10, t + 0.15);
        sub.connect(gSub); gSub.connect(this.masterGain);
        gSub.gain.setValueAtTime(0.4 * size, t);
        gSub.gain.linearRampToValueAtTime(0, t + 0.3);
        sub.start(t); sub.stop(t + 0.3);

        for(let i = 0; i < 2; i++) {
            const duration = baseDuration + Math.random() * 0.2;
            const buf = this.ctx.createBuffer(1, this.ctx.sampleRate * duration, this.ctx.sampleRate);
            const d = buf.getChannelData(0);
            for(let j = 0; j < d.length; j++) d[j] = Math.random() * 2 - 1;
            
            const src = this.ctx.createBufferSource(); src.buffer = buf;
            const f = this.ctx.createBiquadFilter(); 
            f.type = (i === 0) ? 'bandpass' : 'highpass';
            f.frequency.value = (i === 0) ? (500 + Math.random() * 800) : (1500 + Math.random() * 1500);
            f.Q.value = 1;

            const g = this.ctx.createGain();
            src.connect(f); f.connect(g); g.connect(this.masterGain);
            g.gain.setValueAtTime(0.3 * size * (i===0?1:0.5), t);
            g.gain.exponentialRampToValueAtTime(0.01, t + duration);
            src.start(t);
        }
    }
};

const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d', {alpha:false});
let W, H, particles=[], rockets=[];
function resize(){ W=canvas.width=window.innerWidth; H=canvas.height=window.innerHeight; }
window.addEventListener('resize', resize); resize();

class Particle {
    constructor(x,y,c,type){
        this.x=x; this.y=y; this.color=c;
        const a=Math.random()*6.28; const s=Math.random()*(type==='mega'?15:6)+2;
        this.vx=Math.cos(a)*s; this.vy=Math.sin(a)*s;
        this.life=1; this.decay=Math.random()*0.02+0.015;
    }
    update(){ this.vx*=0.95; this.vy+=0.2; this.x+=this.vx; this.y+=this.vy; this.life-=this.decay; }
    draw(){ ctx.globalAlpha=Math.max(0,this.life); ctx.fillStyle=this.color; ctx.beginPath(); ctx.arc(this.x,this.y,3,0,6.28); ctx.fill(); }
}

class Rocket {
    constructor(startX, startY, targetY, color, shape, explosionCallback) {
        this.x = startX;
        this.y = startY;
        this.targetY = targetY;
        this.color = color;
        this.shape = shape;
        this.explosionCallback = explosionCallback;
        this.vy = -Math.random() * 3 - 5; 
        this.trail = [];
        this.life = 1;
        this.r = 3;
    }

    update() {
        // CORRE√á√ÉO: For√ßa o movimento vertical at√© o alvo
        this.y += this.vy;
        this.vy *= 0.98; 
        
        // Adiciona rastros
        this.trail.push({x: this.x, y: this.y, color: this.color, r: this.r});
        if (this.trail.length > 10) this.trail.shift();

        // Condi√ß√£o de explos√£o: se passou ou atingiu o alvo
        if (this.y <= this.targetY) {
            this.explosionCallback(this.x, this.targetY, this.color, this.shape);
            this.life = 0; 
        }
    }

    draw() {
        // CORRE√á√ÉO: Garante que o rastro s√≥ √© desenhado se o foguete estiver vivo
        if(this.life > 0) {
            ctx.globalAlpha = 0.5; // Transpar√™ncia para o rastro
            this.trail.forEach(p => {
                ctx.fillStyle = p.color;
                ctx.beginPath();
                ctx.arc(p.x, p.y, p.r * 0.5, 0, Math.PI * 2);
                ctx.fill();
            });
        }
        
        ctx.globalAlpha = this.life;
        ctx.fillStyle = this.color;
        ctx.beginPath();
        ctx.arc(this.x, this.y, this.r, 0, Math.PI * 2);
        ctx.fill();
    }
}


function createExplosion(x,y, cOverride, sOverride){
    const color = cOverride || DATA.selectedColor;
    const shape = sOverride || DATA.selectedShape;
    const finalC = color==='random' ? `hsl(${Math.random()*360},100%,50%)` : color;
    
    const reward = shape==='mega'?15:5;
    DATA.money += reward;
    showFloat(`+$${reward}`, x, y-30, '#00ff66');
    updateUI();
    saveGame();
    
    AudioSys.playBoom(shape==='mega'?2.5:1);

    const count = shape==='mega'?200:60;
    for(let i=0;i<count;i++){
        const p = new Particle(x,y,finalC,shape);
        if(shape==='star'){ const a=(i/count)*6.28; const r=(i%2)?12:4; p.vx=Math.cos(a)*r; p.vy=Math.sin(a)*r; }
        if(shape==='heart'){ const t=(i/count)*6.28; p.vx=(16*Math.sin(t)**3)*0.5; p.vy=-(13*Math.cos(t)-5*Math.cos(2*t))*0.5; }
        if(shape==='ring'){ const a=(i/count)*6.28; p.vx=Math.cos(a)*8; p.vy=Math.sin(a)*8; }
        particles.push(p);
    }
}

function launchFirework(x = W / 2, y = H * 0.3, cOverride, sOverride) {
    AudioSys.init();
    AudioSys.playLaunch();
    const finalColor = cOverride || DATA.selectedColor;
    const finalShape = sOverride || DATA.selectedShape;

    rockets.push(new Rocket(
        x + Math.random() * 10 - 5, 
        H - 50, 
        y + Math.random() * 100 - 50, 
        finalColor === 'random' ? `hsl(${Math.random()*360},100%,70%)` : finalColor, 
        finalShape,
        createExplosion
    ));
}


function initUI(){
    loadGame();
    
    const cp = document.getElementById('pad-colors');
    COLORS.forEach(c => {
        const btn = document.createElement('div'); btn.className='btn-pad';
        if (c.c === 'random') btn.classList.add('random-color');
        btn.innerHTML = `<span>${c.i}</span>`;
        btn.onclick = (e) => { e.stopPropagation(); selectColor(c.c, btn); };
        if(c.c === DATA.selectedColor) btn.classList.add('selected');
        cp.appendChild(btn);
    });

    renderShop();
    updateUI();
    updateSeqUI(); 
}

function renderShop(){
    const sp = document.getElementById('pad-shapes');
    sp.innerHTML = '';
    SHAPES.forEach(s => {
        const unlocked = DATA.unlocked.includes(s.id);
        const btn = document.createElement('div');
        btn.className = `btn-pad ${unlocked?'':'locked'}`;
        if(s.id === DATA.selectedShape && unlocked) btn.classList.add('selected');
        
        let content = `<span style="font-size:24px">${s.i}</span>`;
        if(!unlocked){
            content += `<div class="lock-overlay"><span>üîí</span><span class="price-tag">$${s.price}</span></div>`;
        }
        btn.innerHTML = content;
        
        btn.onclick = (e) => {
            e.stopPropagation();
            if(unlocked){
                selectShape(s.id);
            } else {
                tryBuy(s, e.clientX, e.clientY);
            }
        };
        sp.appendChild(btn);
    });
}

function tryBuy(item, x, y){
    if(DATA.money >= item.price){
        DATA.money -= item.price;
        DATA.unlocked.push(item.id);
        AudioSys.playEffect('buy');
        showFloat('COMPRADO!', x, y, '#ffd700');
        saveGame();
        renderShop();
        selectShape(item.id); 
    } else {
        AudioSys.playEffect('error');
        showFloat('SEM GRANA!', x, y, '#ff3b30');
    }
}

function selectColor(c, btn){
    AudioSys.init();
    if(DATA.recSlot !== null){
        recordStep(c, null);
    } else {
        DATA.selectedColor = c;
        document.querySelectorAll('#pad-colors .btn-pad').forEach(b=>b.classList.remove('selected'));
        btn.classList.add('selected');
    }
}

function selectShape(sid){
    AudioSys.init();
    if(DATA.recSlot !== null){
        recordStep(null, sid);
    } else {
        DATA.selectedShape = sid;
        renderShop();
    }
}

function recordToggle(idx){
    if(DATA.recSlot === idx){
        DATA.recSlot = null;
    } else {
        DATA.recSlot = idx;
    }
    updateSeqUI();
}

function recordStep(c, s){
    let current = DATA.sequence[DATA.recSlot] || {c: DATA.selectedColor, s: DATA.selectedShape};
    if(c) current.c = c;
    if(s) current.s = s;
    
    DATA.sequence[DATA.recSlot] = current;
    
    if(DATA.recSlot < 3) DATA.recSlot++;
    else DATA.recSlot = null;
    
    updateSeqUI();
}

function clearSequence(){
    DATA.sequence = [null, null, null, null];
    DATA.recSlot = null;
    updateSeqUI();
}

function playSequence(){
    let delay = 0;
    let valid = false;
    DATA.sequence.forEach((step, i) => {
        if(step){
            valid = true;
            setTimeout(() => {
                const tx = W * (0.2 + i*0.2);
                launchFirework(tx, H*0.4, step.c, step.s);
            }, delay);
            delay += 500;
        }
    });
    if(!valid) showFloat("GRAVE PRIMEIRO!", W/2, H/2, 'white');
}

function updateSeqUI(){
    for(let i=0; i<4; i++){
        const el = document.getElementById('slot-'+i);
        const data = DATA.sequence[i];
        
        el.className = `slot ${DATA.recSlot===i ? 'recording' : ''} ${data ? 'filled' : ''}`;
        el.innerHTML = '';
        
        if(data){
            if (data.c === 'random') {
                el.style.background = 'linear-gradient(45deg, #f0f, #0ff, #ff0)';
            } else {
                el.style.backgroundColor = data.c;
            }
            const icon = SHAPES.find(x=>x.id===data.s).i;
            el.innerHTML = `<span class="slot-icon">${icon}</span>`;
        } else {
            el.style.backgroundColor = 'rgba(0,0,0,0.5)';
            el.innerHTML = i+1;
        }
    }
}

function updateUI(){ document.getElementById('money-display').innerText = DATA.money; }
function showFloat(txt, x, y, col){
    const el = document.createElement('div'); el.className='float-txt'; el.innerText=txt;
    el.style.left=x+'px'; el.style.top=y+'px'; el.style.color=col;
    document.body.appendChild(el); setTimeout(()=>el.remove(),1000);
}

function clearVisuals(){ 
    particles=[]; 
    rockets=[]; 
    // Limpeza total da tela para remover rastros persistentes
    ctx.globalCompositeOperation='source-over'; 
    ctx.fillStyle='black'; 
    ctx.fillRect(0,0,W,H); 
} 

function saveGame(){ localStorage.setItem('firework_v6', JSON.stringify({m:DATA.money, u:DATA.unlocked})); }
function loadGame(){
    const s = JSON.parse(localStorage.getItem('firework_v6'));
    if(s){ DATA.money=s.m; DATA.unlocked=s.u; }
}

function loop(){
    requestAnimationFrame(loop);
    // Limpeza suave: apaga um pouco o quadro anterior para deixar o rastro das part√≠culas
    ctx.globalCompositeOperation='source-over'; 
    ctx.fillStyle='rgba(5,5,8,0.2)'; 
    ctx.fillRect(0,0,W,H);
    ctx.globalCompositeOperation='lighter';
    
    for(let i=particles.length-1;i>=0;i--){ particles[i].update(); particles[i].draw(); if(particles[i].life<=0)particles.splice(i,1); }
    for(let i=rockets.length-1;i>=0;i--){ rockets[i].update(); rockets[i].draw(); if(rockets[i].life<=0)rockets.splice(i,1); }
}

window.addEventListener('pointerdown', e => {
    if(e.target.closest('.btn-pad') || e.target.closest('.sequencer-wrapper') || e.target.closest('.btn-clear-canvas') || e.target.closest('.mini-btn') || e.target.closest('#fire-button')) return;
});

initUI();
loop();
</script>
</body>
</html>
