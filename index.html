<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Firework Master 4.0</title>
    <link href="https://fonts.googleapis.com/css2?family=Russo+One&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #050508;
            --glass: rgba(20, 20, 35, 0.8);
            --border: 1px solid rgba(255,255,255,0.1);
            --neon-blue: #00f3ff;
            --neon-pink: #ff00ff;
            --neon-gold: #ffd700;
        }
        body {
            margin: 0; overflow: hidden; background: var(--bg);
            font-family: 'Russo One', sans-serif;
            color: white; user-select: none; touch-action: none;
        }
        canvas { display: block; width: 100%; height: 100%; }

        /* UI LAYOUT GRID */
        #ui {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none;
            display: grid;
            grid-template-columns: 80px 1fr 80px;
            grid-template-rows: 80px 1fr 100px;
            z-index: 10;
        }

        /* HUD SUPERIOR */
        .hud-top {
            grid-column: 1 / -1;
            display: flex; justify-content: space-between; align-items: center;
            padding: 0 20px;
            background: linear-gradient(to bottom, rgba(0,0,0,0.8), transparent);
        }
        .score-box { font-size: 24px; color: var(--neon-gold); text-shadow: 0 0 10px var(--neon-gold); }
        .combo-box { 
            font-size: 32px; color: var(--neon-pink); 
            transform: scale(0); transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .combo-box.active { transform: scale(1); }

        /* SIDEBARS (CONTROLES) */
        .sidebar {
            pointer-events: auto;
            display: flex; flex-direction: column; gap: 10px; padding: 10px;
            background: var(--glass);
            backdrop-filter: blur(5px);
            border-right: var(--border);
            overflow-y: auto;
        }
        .sidebar.right { border-right: none; border-left: var(--border); align-items: center; }

        /* BOT√ïES DE COR E FORMA */
        .btn-opt {
            width: 50px; height: 50px; border-radius: 12px;
            border: 2px solid rgba(255,255,255,0.2);
            cursor: pointer; transition: all 0.2s;
            display: flex; align-items: center; justify-content: center;
            font-size: 20px;
        }
        .btn-opt:active { transform: scale(0.9); }
        .btn-opt.selected { border-color: white; box-shadow: 0 0 15px currentColor; transform: scale(1.1); }
        
        /* BARRA INFERIOR (A√á√ïES ESPECIAIS) */
        .bottom-bar {
            grid-column: 1 / -1;
            pointer-events: auto;
            display: flex; justify-content: center; align-items: center; gap: 20px;
            background: linear-gradient(to top, rgba(0,0,0,0.9), transparent);
            padding-bottom: 20px;
        }
        
        .btn-action {
            padding: 15px 30px; border-radius: 30px; border: none;
            font-family: inherit; font-size: 18px; text-transform: uppercase;
            cursor: pointer; color: #000;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            transition: transform 0.1s;
        }
        .btn-finale { background: linear-gradient(45deg, var(--neon-gold), #ff8800); }
        .btn-clear { background: rgba(255,255,255,0.2); color: white; border: 1px solid white; }
        .btn-action:active { transform: scale(0.95); }

        /* TEXTOS FLUTUANTES */
        .float-txt {
            position: absolute; pointer-events: none; font-size: 20px;
            animation: popUp 0.8s forwards; font-weight: bold;
        }
        @keyframes popUp {
            0% { transform: translate(-50%, 0) scale(0.5); opacity: 0; }
            20% { transform: translate(-50%, -20px) scale(1.5); opacity: 1; }
            100% { transform: translate(-50%, -50px) scale(1); opacity: 0; }
        }

        /* TELA DE TREMOR (Shake) */
        .shake { animation: shake 0.3s; }
        @keyframes shake {
            0% { transform: translate(1px, 1px) rotate(0deg); }
            25% { transform: translate(-1px, -2px) rotate(-1deg); }
            50% { transform: translate(-3px, 0px) rotate(1deg); }
            75% { transform: translate(3px, 2px) rotate(0deg); }
            100% { transform: translate(1px, -1px) rotate(-1deg); }
        }
    </style>
</head>
<body>

    <div id="game-container">
        <canvas id="canvas"></canvas>
        
        <div id="ui">
            <div class="hud-top">
                <div class="score-box">PTS: <span id="score">0</span></div>
                <div id="combo-display" class="combo-box">x1 COMBO!</div>
                <div style="font-size:12px; opacity:0.7">V4.0 MASTER</div>
            </div>

            <div class="sidebar">
                <div style="font-size:10px; text-align:center; margin-bottom:5px">COR</div>
                <div id="palette-container"></div>
            </div>

            <div class="sidebar right">
                <div style="font-size:10px; text-align:center; margin-bottom:5px">FORMA</div>
                <div id="shapes-container"></div>
            </div>

            <div class="bottom-bar">
                <button class="btn-action btn-clear" onclick="resetCanvas()">Limpar</button>
                <button class="btn-action btn-finale" onclick="triggerFinale()">üî• GRAN FINALE</button>
            </div>
        </div>
    </div>

<script>
/* FIREWORK MASTER V4.0 - DJ EDITION */

// --- CONFIGURA√á√ÉO DO JOGO ---
const STATE = {
    color: '#ff0055',
    shape: 'circle',
    score: 0,
    combo: 0,
    comboTimer: null,
    lastClick: 0
};

const COLORS = [
    { c: '#ff0055', label: 'üî¥' }, // Vermelho
    { c: '#00f3ff', label: 'üîµ' }, // Ciano
    { c: '#00ff66', label: 'üü¢' }, // Verde
    { c: '#ffd700', label: 'üü°' }, // Ouro
    { c: '#ff00ff', label: 'üü£' }, // Roxo
    { c: '#ffffff', label: '‚ö™' }, // Branco
    { c: 'random',  label: 'üåà' }  // Random
];

const SHAPES = [
    { id: 'circle', label: '‚óè' },
    { id: 'star',   label: '‚òÖ' },
    { id: 'ring',   label: '‚óé' },
    { id: 'heart',  label: '‚ô•' },
    { id: 'spiral', label: 'üåÄ' },
    { id: 'atom',   label: '‚öõ' },
    { id: 'mega',   label: '‚ò¢' }
];

// --- AUDIO ENGINE (LOUDER & PUNCHIER) ---
const AudioSys = {
    ctx: null,
    masterGain: null,
    init() {
        if(!this.ctx) {
            this.ctx = new (window.AudioContext || window.webkitAudioContext)();
            this.masterGain = this.ctx.createGain();
            this.masterGain.gain.value = 0.8; // Volume Geral Alto
            this.masterGain.connect(this.ctx.destination);
            
            // Compressor para evitar distor√ß√£o no volume m√°ximo
            const comp = this.ctx.createDynamicsCompressor();
            comp.threshold.value = -10;
            comp.knee.value = 40;
            comp.ratio.value = 12;
            comp.connect(this.ctx.destination);
            this.masterGain.disconnect();
            this.masterGain.connect(comp);
        }
        if(this.ctx.state === 'suspended') this.ctx.resume();
    },
    playBoom(type, pitchMod = 0) {
        if(!this.ctx) return;
        const t = this.ctx.currentTime;
        
        // 1. O "Soco" (Grave)
        const osc = this.ctx.createOscillator();
        const g1 = this.ctx.createGain();
        osc.connect(g1); g1.connect(this.masterGain);
        osc.frequency.setValueAtTime(150 + pitchMod*20, t);
        osc.frequency.exponentialRampToValueAtTime(40, t + 0.15);
        g1.gain.setValueAtTime(0.8, t);
        g1.gain.exponentialRampToValueAtTime(0.01, t + 0.2);
        osc.start(t); osc.stop(t + 0.2);

        // 2. O "Estouro" (Ru√≠do)
        const bufferSize = this.ctx.sampleRate * 0.5;
        const buffer = this.ctx.createBuffer(1, bufferSize, this.ctx.sampleRate);
        const data = buffer.getChannelData(0);
        for(let i=0; i<bufferSize; i++) data[i] = Math.random() * 2 - 1;
        
        const noise = this.ctx.createBufferSource();
        noise.buffer = buffer;
        const filter = this.ctx.createBiquadFilter();
        filter.type = 'lowpass';
        filter.frequency.value = 1000 + pitchMod*100;
        
        const g2 = this.ctx.createGain();
        noise.connect(filter); filter.connect(g2); g2.connect(this.masterGain);
        
        g2.gain.setValueAtTime(0.5, t);
        g2.gain.exponentialRampToValueAtTime(0.01, t + (type === 'mega' ? 0.8 : 0.3));
        noise.start(t);
        
        // 3. Laser/Sci-fi (Para formas especiais)
        if(type === 'atom' || type === 'spiral') {
            const osc2 = this.ctx.createOscillator();
            const g3 = this.ctx.createGain();
            osc2.type = 'sawtooth';
            osc2.connect(g3); g3.connect(this.masterGain);
            osc2.frequency.setValueAtTime(800 + pitchMod*50, t);
            osc2.frequency.exponentialRampToValueAtTime(100, t + 0.3);
            g3.gain.setValueAtTime(0.1, t);
            g3.gain.linearRampToValueAtTime(0, t+0.3);
            osc2.start(t); osc2.stop(t+0.3);
        }
    }
};

// --- ENGINE GR√ÅFICA ---
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d', { alpha: false });
let W, H, particles = [];

function resize() { W = canvas.width = window.innerWidth; H = canvas.height = window.innerHeight; }
window.addEventListener('resize', resize);
resize();

// Classe Part√≠cula Otimizada
class Particle {
    constructor(x, y, color, type) {
        this.x = x; this.y = y; this.color = color;
        const angle = Math.random() * Math.PI * 2;
        let speed = Math.random() * 6 + 2;
        this.friction = 0.95; 
        this.gravity = 0.2; 
        this.life = 1; 
        this.decay = Math.random() * 0.02 + 0.015;
        this.size = Math.random() * 2 + 1;

        if(type === 'mega') { speed *= 3; this.decay *= 0.5; this.size = 4; }
        if(type === 'trail') { this.friction = 0.98; }

        this.vx = Math.cos(angle) * speed;
        this.vy = Math.sin(angle) * speed;
    }
    update() {
        this.vx *= this.friction; this.vy *= this.friction; this.vy += this.gravity;
        this.x += this.vx; this.y += this.vy; this.life -= this.decay;
    }
    draw() {
        ctx.globalAlpha = Math.max(0, this.life);
        ctx.fillStyle = this.color;
        ctx.beginPath(); ctx.arc(this.x, this.y, this.size, 0, Math.PI*2); ctx.fill();
    }
}

// --- L√ìGICA DE FORMAS E EXPLOS√ÉO ---
function createExplosion(x, y) {
    // L√≥gica de Combo
    const now = Date.now();
    if(now - STATE.lastClick < 1000) {
        STATE.combo++;
        clearTimeout(STATE.comboTimer);
    } else {
        STATE.combo = 1;
    }
    STATE.lastClick = now;
    STATE.comboTimer = setTimeout(() => { STATE.combo = 0; updateHUD(); }, 1000);
    updateHUD();

    // Screen Shake se for combo alto ou mega
    if(STATE.combo > 5 || STATE.shape === 'mega') {
        document.body.classList.remove('shake');
        void document.body.offsetWidth; // trigger reflow
        document.body.classList.add('shake');
    }

    // Cor
    const c = STATE.color === 'random' ? `hsl(${Math.random()*360}, 100%, 60%)` : STATE.color;
    
    // Som
    AudioSys.playBoom(STATE.shape, Math.min(STATE.combo, 10));

    // Texto flutuante
    showFloatText(STATE.combo > 1 ? `${STATE.combo}x COMBO!` : `+10`, x, y, STATE.combo > 4);

    // Pontos
    STATE.score += 10 * STATE.combo;

    // Gerar Part√≠culas Baseado na Forma
    const count = STATE.shape === 'mega' ? 300 : 80;
    
    for(let i=0; i<count; i++) {
        let p = new Particle(x, y, c, STATE.shape);
        
        // Modificadores de Geometria
        if(STATE.shape === 'star') {
            const a = (i/count)*Math.PI*2;
            const r = (i%2===0)? 10 : 3;
            p.vx = Math.cos(a)*r; p.vy = Math.sin(a)*r;
        }
        else if(STATE.shape === 'ring') {
            const a = (i/count)*Math.PI*2;
            const s = 8;
            p.vx = Math.cos(a)*s; p.vy = Math.sin(a)*s;
        }
        else if(STATE.shape === 'heart') {
             const t = (i/count)*Math.PI*2;
             const xx = 16 * Math.pow(Math.sin(t), 3);
             const yy = 13 * Math.cos(t) - 5 * Math.cos(2 * t) - 2 * Math.cos(3 * t) - Math.cos(4 * t);
             p.vx = xx * 0.4; p.vy = -yy * 0.4;
        }
        else if(STATE.shape === 'spiral') {
            const a = i * 0.2;
            const s = i * 0.05;
            p.vx = Math.cos(a)*s; p.vy = Math.sin(a)*s;
        }
        else if(STATE.shape === 'atom') {
             const a = (i/count)*Math.PI*2;
             // 3 an√©is
             if(i < count/3) { p.vx=Math.cos(a)*8; p.vy=Math.sin(a)*2; } // Horizontal
             else if(i < 2*count/3) { p.vx=Math.cos(a)*2; p.vy=Math.sin(a)*8; } // Vertical
             else { p.vx=Math.cos(a)*6; p.vy=Math.sin(a)*6; } // Diagonal
        }

        particles.push(p);
    }
}

// --- SEQU√äNCIA FINALE ---
function triggerFinale() {
    AudioSys.init();
    let count = 0;
    const interval = setInterval(() => {
        const x = Math.random() * W * 0.8 + W * 0.1;
        const y = Math.random() * H * 0.6 + H * 0.1;
        // For√ßa aleat√≥ria no finale
        const savedShape = STATE.shape;
        const savedColor = STATE.color;
        STATE.shape = SHAPES[Math.floor(Math.random()*SHAPES.length)].id;
        STATE.color = 'random';
        
        createExplosion(x, y);
        
        // Restaura estado
        STATE.shape = savedShape;
        STATE.color = savedColor;

        count++;
        if(count > 15) {
            clearInterval(interval);
            setTimeout(() => createExplosion(W/2, H/2), 500); // √öltima bomba no meio
        }
    }, 200);
}

// --- UI BUILDER ---
function buildUI() {
    // Cores
    const pContainer = document.getElementById('palette-container');
    COLORS.forEach(item => {
        const btn = document.createElement('div');
        btn.className = 'btn-opt';
        btn.innerText = item.label;
        btn.style.color = item.c === 'random' ? 'white' : item.c;
        if(item.c === STATE.color) btn.classList.add('selected');
        
        btn.onclick = (e) => {
            e.stopPropagation();
            STATE.color = item.c;
            updateSelection(pContainer, btn);
            AudioSys.init(); // Garante audio
        };
        pContainer.appendChild(btn);
    });

    // Formas
    const sContainer = document.getElementById('shapes-container');
    SHAPES.forEach(item => {
        const btn = document.createElement('div');
        btn.className = 'btn-opt';
        btn.innerText = item.label;
        if(item.id === STATE.shape) btn.classList.add('selected');
        
        btn.onclick = (e) => {
            e.stopPropagation();
            STATE.shape = item.id;
            updateSelection(sContainer, btn);
            AudioSys.init();
        };
        sContainer.appendChild(btn);
    });
}

function updateSelection(container, activeBtn) {
    Array.from(container.children).forEach(c => c.classList.remove('selected'));
    activeBtn.classList.add('selected');
}

function updateHUD() {
    document.getElementById('score').innerText = STATE.score;
    const cb = document.getElementById('combo-display');
    if(STATE.combo > 1) {
        cb.innerText = `${STATE.combo}x COMBO!`;
        cb.classList.add('active');
    } else {
        cb.classList.remove('active');
    }
}

function showFloatText(text, x, y, isBig) {
    const el = document.createElement('div');
    el.className = 'float-txt';
    el.innerText = text;
    el.style.left = x + 'px'; el.style.top = y + 'px';
    el.style.color = isBig ? '#ffd700' : '#fff';
    if(isBig) el.style.fontSize = '40px';
    document.body.appendChild(el);
    setTimeout(() => el.remove(), 800);
}

function resetCanvas() {
    particles = [];
    ctx.fillStyle = 'black';
    ctx.fillRect(0,0,W,H);
}

// --- LOOP PRINCIPAL ---
function loop() {
    requestAnimationFrame(loop);
    
    // Rastro suave
    ctx.globalCompositeOperation = 'source-over';
    ctx.fillStyle = 'rgba(5, 5, 8, 0.25)';
    ctx.fillRect(0, 0, W, H);

    // Desenhar Part√≠culas
    ctx.globalCompositeOperation = 'lighter'; // Brilho Neon
    for(let i = particles.length - 1; i >= 0; i--) {
        particles[i].update();
        particles[i].draw();
        if(particles[i].life <= 0) particles.splice(i, 1);
    }
}

// START
buildUI();
loop();

// INPUT GLOBAL
window.addEventListener('pointerdown', (e) => {
    if(e.target.closest('.btn-opt') || e.target.closest('.btn-action')) return;
    AudioSys.init();
    createExplosion(e.clientX, e.clientY);
});

</script>
</body>
</html>
